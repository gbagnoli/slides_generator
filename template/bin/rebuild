#!/bin/bash

sources="slides.md Makefile"
SERVE_PID=

build() {
    # vim use move_self, we need to wait a bit or the file won't be found
    sleep 0.1
    make all
    res=$?
    [ $res -ne 0 ] && echo "--- FAILED BUILD ---" || echo "--- OK ---"
    return $res
}

serve() {
  make serve &
  SERVE_PID=$!
}

darwin() {
  build
  while fswatch -1 slides.md; do
    build
  done
}

linux() {
  if ! command -v inotifywait &>/dev/null; then
    echo >&2 "Missing inotifywait. Make sure to install inotify-tools"
    exit 1
  fi

  build
  serve
  # shellcheck disable=SC2086
  while inotifywait -e move_self -e modify $sources; do
      build
  done
}

quit() {
  if [ -n "$SERVE_PID" ]; then
    kill "$SERVE_PID"
  fi
  exit
}

trap quit INT

if [[ "$(uname)" == "Darwin" ]]; then
  darwin
else
  linux
fi
